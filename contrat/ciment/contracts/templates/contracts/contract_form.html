<!-- contract_form.html - Version refondue -->
{% extends 'base_project.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block extra_css %}
<link href="{% static 'css/vendor/spectrum-table.css' %}" rel="stylesheet" />
<link href="{% static 'css/excel-table.css' %}" rel="stylesheet" />
<link href="{% static 'css/vendor/spectrum-button.css' %}" rel="stylesheet" />
<link href="{% static 'css/vendor/spectrum-badge.css' %}" rel="stylesheet" />
{% endblock %}

{% block title %}{% if contract %}Edit Contract{% else %}Create Contract{% endif %}{% endblock %}
{% block page_title %}{% if contract %}Edit Contract{% else %}Create New Contract{% endif %}{% endblock %}

{% block content %}
<div class="enterprise-card">
  <div class="card-header">
    <h3 class="h4 mb-0">{% if contract %}Update Contract Details{% else %}Enter Contract Information{% endif %}</h3>
  </div>
  
  <div class="card-body">
    <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
      {% csrf_token %}
      
      {% if form.non_field_errors %}
      <div class="alert p-3 mb-4 border rounded" style="background: var(--danger-light); border-color: var(--danger);">
        <div class="d-flex align-items-center">
          <i class='bx bx-error-circle text-danger me-2'></i>
          <div>
            <strong>Validation Errors</strong>
            <ul class="mb-0 mt-1">
            {% for error in form.non_field_errors %}
              <li>{{ error }}</li>
            {% endfor %}
            </ul>
          </div>
        </div>
      </div>
      {% endif %}
      
      <!-- General Information -->
      <div class="mb-5">
        <h4 class="h4 mb-4 pb-2 border-bottom">General Information</h4>
        
        <div class="row g-3">
          <div class="col-md-6">
            <div class="form-group">
              <label for="{{ form.numero.id_for_label }}" class="form-label required">Contract Number</label>
              {{ form.numero }}
              {% if form.numero.errors %}
              <div class="text-danger mt-1" style="font-size: 12px;">{{ form.numero.errors.0 }}</div>
              {% endif %}
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="form-group">
              <label for="{{ form.type.id_for_label }}" class="form-label required">Contract Type</label>
              {{ form.type }}
              {% if form.type.errors %}
              <div class="text-danger mt-1" style="font-size: 12px;">{{ form.type.errors.0 }}</div>
              {% endif %}
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label for="{{ form.objet.id_for_label }}" class="form-label required">Contract Description</label>
          {{ form.objet }}
          {% if form.objet.errors %}
          <div class="text-danger mt-1" style="font-size: 12px;">{{ form.objet.errors.0 }}</div>
          {% endif %}
          <div class="text-muted mt-1" style="font-size: 12px;">Provide a clear description of the contract purpose</div>
        </div>
        
        <div class="row g-3">
          <div class="col-md-4">
            <div class="form-group">
              <label for="{{ form.type_contrat.id_for_label }}" class="form-label">Contract Category</label>
              {{ form.type_contrat }}
            </div>
          </div>
          
          <div class="col-md-4">
            <div class="form-group">
              <label for="{{ form.type_activite.id_for_label }}" class="form-label">Activity Type</label>
              {{ form.type_activite }}
            </div>
          </div>
          
          <div class="col-md-4">
            <div class="form-group">
              <label for="{{ form.supplier.id_for_label }}" class="form-label required">Supplier</label>
              {{ form.supplier }}
              {% if form.supplier.errors %}
              <div class="text-danger mt-1" style="font-size: 12px;">{{ form.supplier.errors.0 }}</div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      
      <!-- Financial Information -->
      <div class="mb-5">
        <h4 class="h4 mb-4 pb-2 border-bottom">Financial Information</h4>
        
        <div class="row g-3">
          <div class="col-md-6">
            <div class="form-group">
              <label for="{{ form.montant.id_for_label }}" class="form-label required">Contract Value</label>
              {{ form.montant }}
              {% if form.montant.errors %}
              <div class="text-danger mt-1" style="font-size: 12px;">{{ form.montant.errors.0 }}</div>
              {% endif %}
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="form-group">
              <label for="{{ form.devise.id_for_label }}" class="form-label required">Currency</label>
              {{ form.devise }}
              {% if form.devise.errors %}
              <div class="text-danger mt-1" style="font-size: 12px;">{{ form.devise.errors.0 }}</div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      
      <!-- Timeline -->
      <div class="mb-5">
        <h4 class="h4 mb-4 pb-2 border-bottom">Contract Timeline</h4>
        
        <div class="row g-3">
          <div class="col-md-4">
            <div class="form-group">
              <label for="{{ form.date_signature.id_for_label }}" class="form-label required">Signature Date</label>
              {{ form.date_signature }}
              {% if form.date_signature.errors %}
              <div class="text-danger mt-1" style="font-size: 12px;">{{ form.date_signature.errors.0 }}</div>
              {% endif %}
            </div>
          </div>
          
          <div class="col-md-4">
            <div class="form-group">
              <label for="{{ form.date_effet.id_for_label }}" class="form-label required">Effective Date</label>
              {{ form.date_effet }}
              {% if form.date_effet.errors %}
              <div class="text-danger mt-1" style="font-size: 12px;">{{ form.date_effet.errors.0 }}</div>
              {% endif %}
            </div>
          </div>
          
          <div class="col-md-4">
            <div class="form-group">
              <label for="{{ form.date_expiry.id_for_label }}" class="form-label required">Expiry Date</label>
              {{ form.date_expiry }}
              {% if form.date_expiry.errors %}
              <div class="text-danger mt-1" style="font-size: 12px;">{{ form.date_expiry.errors.0 }}</div>
              {% endif %}
            </div>
          </div>
        </div>
        
        <div class="row g-3">
          <div class="col-md-6">
            <div class="form-group">
              <label for="{{ form.preavis.id_for_label }}" class="form-label">Notice Period (days)</label>
              {{ form.preavis }}
              <div class="text-muted mt-1" style="font-size: 12px;">Default: 90 days before expiry</div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="form-group">
              <label for="{{ form.duree_contrat.id_for_label }}" class="form-label">Contract Duration (years)</label>
              {{ form.duree_contrat }}
              <div class="text-muted mt-1" style="font-size: 12px;">Between 1 and 5 years</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Renewal -->
      <div class="mb-5">
        <h4 class="h4 mb-4 pb-2 border-bottom">Renewal Settings</h4>
        
        <div class="row g-3">
          <div class="col-md-12">
            <div class="form-group">
              <label for="{{ form.type_renouvellement.id_for_label }}" class="form-label">Renewal Type</label>
              {{ form.type_renouvellement }}
            </div>
          </div>
        </div>
      </div>
      
      <!-- Status (for edit only) -->
      {% if contract %}
      <div class="mb-5">
        <h4 class="h4 mb-4 pb-2 border-bottom">Contract Status</h4>
        
        <div class="row g-3">
          <div class="col-md-12">
            <div class="form-group">
              <label for="{{ form.status.id_for_label }}" class="form-label">Status</label>
              {{ form.status }}
            </div>
          </div>
        </div>
      </div>
      {% endif %}
      
      <!-- Form Actions -->
      <div class="d-flex justify-content-end gap-3 pt-4 border-top">
        <a href="{% url 'contracts:list' %}" class="btn btn-outline">
          Cancel
        </a>
        <button type="submit" class="btn btn-primary">
          <i class='bx bx-save'></i>
          {% if contract %}Update Contract{% else %}Create Contract{% endif %}
        </button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Add form-control class to all form inputs
    const inputs = document.querySelectorAll('input[type="text"], input[type="number"], input[type="email"], input[type="url"], input[type="date"], textarea');
    inputs.forEach(el => {
      el.classList.add('form-control');
    });

    const selects = document.querySelectorAll('select');
    selects.forEach(el => {
      el.classList.add('form-control');
    });

    // Date picker enhancement
    const dateInputs = document.querySelectorAll('input[type="date"]');
    dateInputs.forEach(input => {
      input.addEventListener('focus', function() {
        this.type = 'date';
      });
      input.addEventListener('blur', function() {
        if (!this.value) this.type = 'text';
      });
    });
  });
</script>
{% endblock %}