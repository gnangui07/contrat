{% extends 'base_project.html' %}
{% load static %}
{% block title %}PO {{ purchase_order.number }} - Détail{% endblock %}

{% block extra_css %}
<link href="{% static 'css/excel-table.css' %}" rel="stylesheet" />
{% endblock %}

{% block extra_js %}
<script src="{% static 'orders/orders.js' %}"></script>
{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="display-6 fw-bold text-dark">
        <i class='bx bx-file me-2 text-primary'></i>Bon de commande {{ purchase_order.number }}
      </h1>
      <p class="text-muted lead mb-0">Détail complet du purchasing document</p>
    </div>
    <a href="{% url 'orders:purchase_order_list' %}" class="btn btn-outline-secondary">
      <i class='bx bx-arrow-back me-1'></i> Retour à la liste
    </a>
  </div>

  <div class="row g-4 mb-4">
    <div class="col-xl-4 col-lg-6">
      <div class="card shadow-sm h-100 border-start border-4 border-info">
        <div class="card-body p-4">
          <h6 class="card-subtitle mb-2 text-muted text-uppercase small">
            <i class='bx bx-buildings me-1'></i> Fournisseur
          </h6>
          {% if purchase_order.supplier %}
          <p class="mb-0 fw-bold fs-4 text-dark">{{ purchase_order.supplier.nom_complet_organisation }}</p>
          {% else %}
          <p class="mb-0 text-muted fst-italic">Non renseigné</p>
          {% endif %}
        </div>
      </div>
    </div>
    
    <div class="col-xl-8 col-lg-6">
      <div class="row g-3">
        <div class="col-md-3 col-sm-6">
          <div class="card shadow-sm border-0 h-100">
            <div class="card-body py-3 text-center">
              <h6 class="card-subtitle mb-1 text-muted text-uppercase small">Total</h6>
              <div class="fw-bold fs-4">
                {{ total_amount|floatformat:0 }}
                <small class="text-muted d-block small fs-6">{{ purchase_order.get_currency|default:"" }}</small>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="card shadow-sm border-0 h-100">
            <div class="card-body py-3 text-center">
              <h6 class="card-subtitle mb-1 text-muted text-uppercase small">Reçu</h6>
              <div class="fw-bold fs-4 text-success">
                {{ received_amount|floatformat:0 }}
                <small class="text-muted d-block small fs-6">{{ purchase_order.get_currency|default:"" }}</small>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="card shadow-sm border-0 h-100 bg-primary text-white">
            <div class="card-body py-3 text-center">
              <h6 class="card-subtitle mb-1 text-white-50 text-uppercase small">Restant</h6>
              <div class="fw-bold fs-4">
                {{ remaining_amount|floatformat:0 }}
                <small class="text-white-50 d-block small fs-6">{{ purchase_order.get_currency|default:"" }}</small>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="card shadow-sm border-0 h-100">
            <div class="card-body py-3 text-center">
              <h6 class="card-subtitle mb-1 text-muted text-uppercase small">Avancement</h6>
              <div class="fw-bold fs-4 mb-1">
                {% with rate=progress_rate|default_if_none:"0" %}
                  {% if rate|floatformat:0 >= 80 %}
                    <span class="badge bg-success">{{ rate|floatformat:0 }}%</span>
                  {% elif rate|floatformat:0 >= 50 %}
                    <span class="badge bg-warning text-dark">{{ rate|floatformat:0 }}%</span>
                  {% else %}
                    <span class="badge bg-danger">{{ rate|floatformat:0 }}%</span>
                  {% endif %}
                {% endwith %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm border-0 mb-4">
    <div class="card-header bg-white py-3 border-0">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="m-0 fw-bold text-primary">
          <i class='bx bx-list-ul me-2'></i> Lignes du bon de commande
        </h5>
        <span class="badge bg-light text-dark border">{{ lines|length }} ligne(s)</span>
      </div>
    </div>
    
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th class="border-end ps-3">Item</th>
              <th>Material</th>
              <th>Short Text</th>
              <th>Unit</th>
              <th>Curr</th>
              <th>Supplier</th>
              <th>Rel. Ind.</th>
              <th>Doc Date</th>
              <th>Purch. Grp</th>
              <th>Rel. Date</th>
              <th>Created By</th>
              <th class="text-end border-start">Net Order Val</th>
              <th class="text-end">Order Qty</th>
              <th class="text-end">Net Price</th>
              <th class="text-end">Recv Qty</th>
              <th class="text-end">To Deliver</th>
              <th class="text-end">Recv Amt</th>
              <th class="text-end pe-3">Rem Amt</th>
            </tr>
          </thead>
          <tbody>
            {% if lines %}
            {% for line in lines %}
            <tr>
              <td class="fw-semibold border-end ps-3">{{ line.item }}</td>
              <td><code class="text-primary">{{ line.material|default:"—" }}</code></td>
              <td>
                <span class="d-inline-block text-truncate" style="max-width: 150px;" title="{{ line.short_text|default:'—' }}">
                  {{ line.short_text|default:"—" }}
                </span>
              </td>
              <td>{{ line.order_unit|default:"—" }}</td>
              <td><span class="badge bg-light text-dark border">{{ line.currency|default:"—" }}</span></td>
              <td>
                <small class="text-muted">{{ purchase_order.supplier.nom_complet_organisation|default:"—"|truncatewords:2 }}</small>
              </td>
              <td>{{ purchase_order.release_indicator|default:"—" }}</td>
              <td><small>{{ purchase_order.document_date|default:"—"|slice:":10" }}</small></td>
              <td><small>{{ purchase_order.purchasing_group|default:"—" }}</small></td>
              <td><small>{{ purchase_order.release_date|default:"—"|slice:":10" }}</small></td>
              <td><small>{{ purchase_order.created_by|default:"—" }}</small></td>
              <td class="text-end fw-bold border-start">{{ line.net_order_value|default_if_none:"0"|floatformat:0 }}</td>
              <td class="text-end">{{ line.order_quantity|default_if_none:"0"|floatformat:0 }}</td>
              <td class="text-end">{{ line.net_price|default_if_none:"0"|floatformat:0 }}</td>
              <td class="text-end text-success">{{ line.received_quantity|default_if_none:"0"|floatformat:0 }}</td>
              <td class="text-end text-warning">{{ line.still_to_be_delivered_qty|default_if_none:"0"|floatformat:0 }}</td>
              <td class="text-end text-success fw-semibold">{{ line.get_line_received_amount|default_if_none:"0"|floatformat:0 }}</td>
              <td class="text-end text-warning fw-semibold pe-3">{{ line.get_line_remaining_amount|default_if_none:"0"|floatformat:0 }}</td>
            </tr>
            {% endfor %}
            {% else %}
            <tr>
              <td colspan="18" class="text-center py-5">
                <div class="text-muted">
                  <i class='bx bx-file-blank display-4 mb-3'></i>
                  <h4>Aucune ligne trouvée</h4>
                  <p>Ce bon de commande ne contient aucune ligne.</p>
                </div>
              </td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Résumé mobile -->
  <div class="d-block d-md-none mt-4">
    <div class="card bg-light border-0">
      <div class="card-body py-3">
        <div class="row text-center g-3">
          <div class="col-6">
            <small class="text-muted d-block">Total lignes</small>
            <div class="fw-bold text-primary">{{ lines|length }}</div>
          </div>
          <div class="col-6">
            <small class="text-muted d-block">Mise à jour</small>
            <div class="fw-bold">{{ purchase_order.updated_at|default:"—"|date:"d/m/Y" }}</div>
          </div>
          <div class="col-12">
            <small class="text-muted d-block mb-1">Statut</small>
            <div>
              {% if progress_rate == 100 %}
                <span class="badge bg-success w-100 py-2">Complété</span>
              {% elif progress_rate > 0 %}
                <span class="badge bg-warning w-100 py-2 text-dark">En cours</span>
              {% else %}
                <span class="badge bg-secondary w-100 py-2">Non commencé</span>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
