{% extends 'base_project.html' %}
{% block title %}Tableau de bord - Dangote Cement{% endblock %}
{% block extra_css %}
<style>
  .dashboard-container { padding: 20px; max-width: 1400px; margin: 0 auto; }
  .page-header { margin-bottom: 30px; }
  .page-header h1 { font-size: 28px; color: #333; margin-bottom: 10px; }
  .page-header p { color: #666; font-size: 14px; }
  .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 40px; }
  .stat-card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #0052CC; transition: transform 0.2s; }
  .stat-card:hover { transform: translateY(-5px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
  .stat-card.orange { border-left-color: #FF5722; }
  .stat-card.green { border-left-color: #2e7d32; }
  .stat-card h3 { font-size: 13px; color: #666; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 8px; }
  .stat-card h3 i { font-size: 20px; color: #0052CC; }
  .stat-card.orange h3 i { color: #FF5722; }
  .stat-card.green h3 i { color: #2e7d32; }
  .stat-card .value { font-size: 36px; font-weight: 700; color: #0052CC; margin-bottom: 8px; }
  .stat-card.orange .value { color: #FF5722; }
  .stat-card.green .value { color: #2e7d32; }
  .stat-card .label { font-size: 13px; color: #999; }
  .section-title { font-size: 20px; font-weight: 600; margin: 40px 0 20px; color: #333; display: flex; align-items: center; gap: 10px; }
  .section-title i { color: #0052CC; }
  .table-container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; }
  thead { background: #f8f9fa; }
  th { padding: 15px 12px; text-align: left; font-weight: 600; color: #333; font-size: 13px; border-bottom: 2px solid #0052CC; white-space: nowrap; }
  td { padding: 15px 12px; border-bottom: 1px solid #eee; font-size: 14px; }
  tr:hover { background: #f8f9fa; }
  .badge { padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; display: inline-block; }
  .badge-success { background: #e8f5e9; color: #2e7d32; }
  .badge-warning { background: #fff3e0; color: #f57c00; }
  .badge-danger { background: #ffebee; color: #c62828; }
  .badge-pending { background: #fff3e0; color: #f57c00; }
  .badge-active { background: #e8f5e9; color: #2e7d32; }
  .badge-expired { background: #ffebee; color: #c62828; }
  .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; text-decoration: none; display: inline-block; font-size: 13px; }
  .btn-primary { background: #0052CC; color: white; }
  .btn-primary:hover { background: #003D99; }
  .empty-state { text-align: center; padding: 40px 20px; color: #999; }
  .empty-state i { font-size: 48px; color: #ddd; margin-bottom: 15px; }
  .contract-number { font-weight: 600; color: #0052CC; }
  .quick-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 40px; }
  .quick-action { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; text-decoration: none; color: #333; transition: all 0.2s; }
  .quick-action:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
  .quick-action i { font-size: 32px; color: #0052CC; margin-bottom: 10px; }
  .quick-action span { display: block; font-weight: 600; font-size: 14px; }
</style>
{% endblock %}
{% block content %}
<div class="dashboard-container">
  <div class="page-header">
    <h1>Tableau de bord</h1>
    <p>Bienvenue, {{ user.get_full_name|default:user.email }}</p>
  </div>

  {% if is_superuser %}
  <!-- Vue Superuser -->
  <div class="stats-grid">
    <div class="stat-card">
      <h3><i class='bx bx-file'></i> Total Contrats</h3>
      <div class="value">{{ total_contracts }}</div>
      <div class="label">Tous statuts confondus</div>
    </div>
    <div class="stat-card orange">
      <h3><i class='bx bx-time'></i> En attente</h3>
      <div class="value">{{ pending_contracts }}</div>
      <div class="label">Contrats à valider</div>
    </div>
    <div class="stat-card green">
      <h3><i class='bx bx-check-circle'></i> Actifs</h3>
      <div class="value">{{ active_contracts }}</div>
      <div class="label">Contrats en cours</div>
    </div>
    <div class="stat-card">
      <h3><i class='bx bx-buildings'></i> Fournisseurs</h3>
      <div class="value">{{ total_suppliers }}</div>
      <div class="label">
        Actifs : {{ compliant_suppliers }} | Inactifs : {{ non_compliant_suppliers }}
      </div>
    </div>
  </div>

  <!-- Statistiques fournisseurs & évaluations -->
  <div class="stats-grid">
    <div class="stat-card orange">
      <h3><i class='bx bx-star'></i> Évaluations Vendor</h3>
      <div class="value">{{ vendor_evaluations_count }}</div>
      <div class="label">Nombre total d'évaluations Vendor</div>
    </div>

    <div class="stat-card orange">
      <h3><i class='bx bx-user-check'></i> Évaluations Buyer</h3>
      <div class="value">{{ buyer_evaluations_count }}</div>
      <div class="label">Nombre total d'évaluations Buyer</div>
    </div>

    <div class="stat-card green">
      <h3><i class='bx bx-line-chart'></i> Fournisseurs évalués</h3>
      <div class="value">{{ evaluated_suppliers_count }}</div>
      <div class="label">Au moins une évaluation Vendor ou Buyer</div>
    </div>
  </div>

  <!-- Actions rapides -->
  <div class="quick-actions">
    <a href="{% url 'contracts:create' %}" class="quick-action">
      <i class='bx bx-plus-circle'></i>
      <span>Nouveau contrat</span>
    </a>
    <a href="{% url 'suppliers:create' %}" class="quick-action">
      <i class='bx bx-building-house'></i>
      <span>Nouveau fournisseur</span>
    </a>
    <a href="{% url 'contracts:list' %}" class="quick-action">
      <i class='bx bx-list-ul'></i>
      <span>Voir tous les contrats</span>
    </a>
    <a href="{% url 'suppliers:list' %}" class="quick-action">
      <i class='bx bx-group'></i>
      <span>Voir tous les fournisseurs</span>
    </a>
  </div>

  <!-- Contrats en attente de validation -->
  <h2 class="section-title"><i class='bx bx-time-five'></i> Contrats en attente de validation</h2>
  <div class="table-container">
    {% if pending_for_validation %}
    <table>
      <thead>
        <tr>
          <th>Numéro</th>
          <th>Objet</th>
          <th>Fournisseur</th>
          <th>Type</th>
          <th>Montant</th>
          <th>Date création</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for contract in pending_for_validation %}
        <tr>
          <td><span class="contract-number">{{ contract.numero }}</span></td>
          <td>{{ contract.objet|truncatewords:6 }}</td>
          <td>{{ contract.supplier.nom_complet_organisation|truncatewords:4 }}</td>
          <td>{{ contract.get_type_display }}</td>
          <td><strong>{{ contract.montant|floatformat:0 }} {{ contract.devise }}</strong></td>
          <td>{{ contract.date_creation|date:"d/m/Y H:i" }}</td>
          <td>
            <a href="{% url 'contracts:detail' contract.pk %}" class="btn btn-primary">Voir</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <div class="empty-state">
      <i class='bx bx-check-circle'></i>
      <p>Aucun contrat en attente de validation</p>
    </div>
    {% endif %}
  </div>

  {% else %}
  <!-- Vue Collaborateur -->
  <div class="stats-grid">
    <div class="stat-card">
      <h3><i class='bx bx-file'></i> Mes Contrats</h3>
      <div class="value">{{ my_contracts_count }}</div>
      <div class="label">Total créés</div>
    </div>
    <div class="stat-card orange">
      <h3><i class='bx bx-time'></i> En attente</h3>
      <div class="value">{{ my_pending_contracts }}</div>
      <div class="label">À valider</div>
    </div>
    <div class="stat-card green">
      <h3><i class='bx bx-check-circle'></i> Actifs</h3>
      <div class="value">{{ my_active_contracts }}</div>
      <div class="label">En cours</div>
    </div>
    <div class="stat-card">
      <h3><i class='bx bx-buildings'></i> Fournisseurs</h3>
      <div class="value">{{ my_suppliers_count }}</div>
      <div class="label">Gérés</div>
    </div>
  </div>

  <!-- Actions rapides -->
  <div class="quick-actions">
    <a href="{% url 'contracts:create' %}" class="quick-action">
      <i class='bx bx-plus-circle'></i>
      <span>Nouveau contrat</span>
    </a>
    <a href="{% url 'suppliers:create' %}" class="quick-action">
      <i class='bx bx-building-house'></i>
      <span>Nouveau fournisseur</span>
    </a>
    <a href="{% url 'contracts:list' %}" class="quick-action">
      <i class='bx bx-list-ul'></i>
      <span>Mes contrats</span>
    </a>
  </div>

  <!-- Mes derniers contrats -->
  <h2 class="section-title"><i class='bx bx-history'></i> Mes derniers contrats</h2>
  <div class="table-container">
    {% if my_contracts %}
    <table>
      <thead>
        <tr>
          <th>Numéro</th>
          <th>Objet</th>
          <th>Type</th>
          <th>Montant</th>
          <th>Statut</th>
          <th>Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for contract in my_contracts %}
        <tr>
          <td><span class="contract-number">{{ contract.numero }}</span></td>
          <td>{{ contract.objet|truncatewords:6 }}</td>
          <td>{{ contract.get_type_display }}</td>
          <td><strong>{{ contract.montant|floatformat:0 }} {{ contract.devise }}</strong></td>
          <td>
            {% if contract.status == 'active' %}
            <span class="badge badge-active">Actif</span>
            {% elif contract.status == 'pending' %}
            <span class="badge badge-pending">En attente</span>
            {% elif contract.status == 'expired' %}
            <span class="badge badge-expired">Expiré</span>
            {% else %}
            <span class="badge badge-danger">{{ contract.get_status_display }}</span>
            {% endif %}
          </td>
          <td>{{ contract.date_creation|date:"d/m/Y" }}</td>
          <td>
            <a href="{% url 'contracts:detail' contract.pk %}" class="btn btn-primary">Voir</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <div class="empty-state">
      <i class='bx bx-file'></i>
      <p>Aucun contrat créé</p>
      <a href="{% url 'contracts:create' %}" class="btn btn-primary" style="margin-top: 15px;">Créer mon premier contrat</a>
    </div>
    {% endif %}
  </div>
  {% endif %}
</div>
{% endblock %}
