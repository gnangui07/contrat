{% extends 'base_project.html' %}
{% load static %}
{% block title %}PO {{ purchase_order.number }} - Détail{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
<link rel="stylesheet" href="{% static 'orders/orders.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="page-header">
    <div>
      <h1>
        <i class="fas fa-file-invoice me-2 text-primary"></i>
        Bon de commande {{ purchase_order.number }}
      </h1>
      <p class="text-muted mb-0">Détail complet du purchasing document</p>
    </div>
    <a href="{% url 'orders:purchase_order_list' %}" class="btn btn-outline-primary">
      <i class="fas fa-arrow-left me-1"></i>
      Retour à la liste
    </a>
  </div>

  <div class="row g-4 mb-4">
    <div class="col-xl-4 col-lg-6">
      <div class="card shadow-sm h-100 po-supplier-card">
        <div class="card-body">
          <h6 class="card-subtitle mb-2">
            <i class="fas fa-industry me-1"></i>
            Fournisseur
          </h6>
          {% if purchase_order.supplier %}
          <p class="mb-0 fw-semibold fs-5 text-dark">{{ purchase_order.supplier.nom_complet_organisation }}</p>
          {% else %}
          <p class="mb-0 text-muted">Non renseigné</p>
          {% endif %}
        </div>
      </div>
    </div>
    
    <div class="col-xl-8 col-lg-6">
      <div class="row g-3">
        <div class="col-md-3 col-sm-6">
          <div class="card shadow-sm h-100 po-summary-card">
            <div class="card-body py-3 text-center">
              <h6 class="card-subtitle mb-1 text-muted text-uppercase small">Total</h6>
              <div class="fw-bold fs-4">
                {{ total_amount|floatformat:0 }}
                <small class="text-muted d-block small">{{ purchase_order.get_currency|default:"" }}</small>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="card shadow-sm h-100 po-summary-card">
            <div class="card-body py-3 text-center">
              <h6 class="card-subtitle mb-1 text-muted text-uppercase small">Reçu</h6>
              <div class="fw-bold fs-4 text-success">
                {{ received_amount|floatformat:0 }}
                <small class="d-block small text-muted">{{ purchase_order.get_currency|default:"" }}</small>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="card shadow-sm h-100 po-summary-card">
            <div class="card-body py-3 text-center">
              <h6 class="card-subtitle mb-1 text-muted text-uppercase small">Restant</h6>
              <div class="fw-bold fs-4 text-white">
                {{ remaining_amount|floatformat:0 }}
                <small class="d-block small text-muted">{{ purchase_order.get_currency|default:"" }}</small>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="card shadow-sm h-100 po-summary-card">
            <div class="card-body py-3 text-center">
              <h6 class="card-subtitle mb-1 text-muted text-uppercase small">Avancement</h6>
              <div class="fw-bold fs-4 mb-1">
                {% with rate=progress_rate|default_if_none:"0" %}
                  {% if rate|floatformat:0 >= 80 %}
                    <span class="badge bg-success">{{ rate|floatformat:0 }}%</span>
                  {% elif rate|floatformat:0 >= 50 %}
                    <span class="badge bg-warning text-dark">{{ rate|floatformat:0 }}%</span>
                  {% else %}
                    <span class="badge bg-danger">{{ rate|floatformat:0 }}%</span>
                  {% endif %}
                {% endwith %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm border-0">
    <div class="card-header bg-white border-bottom">
      <h5 class="card-title mb-0">
        <i class="fas fa-list-ul me-2 text-primary"></i>
        Lignes du bon de commande
      </h5>
      <p class="text-muted mb-0 small">{{ lines|length }} ligne(s) trouvée(s)</p>
    </div>
    
    <div class="table-container">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-primary">
          <tr>
            <th class="border-end">Item</th>
            <th>Material</th>
            <th>Short Text</th>
            <th>Order Unit</th>
            <th>Currency</th>
            <th>Supplier</th>
            <th>Release indicator</th>
            <th>Document Date</th>
            <th>Purchasing Group</th>
            <th>Release Date</th>
            <th>Created By</th>
            <th class="text-right border-start">Net Order Value</th>
            <th class="text-right">Order Quantity</th>
            <th class="text-right">Net Price</th>
            <th class="text-right">Received Quantity</th>
            <th class="text-right">Still to be delivered</th>
            <th class="text-right">Received Amount</th>
            <th class="text-right">Remaining Amount</th>
          </tr>
        </thead>
        <tbody>
          {% if lines %}
          {% for line in lines %}
          <tr>
            <td class="fw-semibold border-end">{{ line.item }}</td>
            <td><code class="text-primary">{{ line.material|default:"—" }}</code></td>
            <td>
              <span class="text-truncate" title="{{ line.short_text|default:'—' }}">
                {{ line.short_text|default:"—"|truncatewords:5 }}
              </span>
            </td>
            <td>{{ line.order_unit|default:"—" }}</td>
            <td><span class="badge bg-light text-dark">{{ line.currency|default:"—" }}</span></td>
            <td>
              <small>{{ purchase_order.supplier.nom_complet_organisation|default:"—"|truncatewords:3 }}</small>
            </td>
            <td>{{ purchase_order.release_indicator|default:"—" }}</td>
            <td><small>{{ purchase_order.document_date|default:"—"|slice:":10" }}</small></td>
            <td><small>{{ purchase_order.purchasing_group|default:"—" }}</small></td>
            <td><small>{{ purchase_order.release_date|default:"—"|slice:":10" }}</small></td>
            <td><small>{{ purchase_order.created_by|default:"—" }}</small></td>
            <td class="text-right fw-bold border-start">{{ line.net_order_value|default_if_none:"0"|floatformat:0 }}</td>
            <td class="text-right">{{ line.order_quantity|default_if_none:"0"|floatformat:0 }}</td>
            <td class="text-right">{{ line.net_price|default_if_none:"0"|floatformat:0 }}</td>
            <td class="text-right text-success">{{ line.received_quantity|default_if_none:"0"|floatformat:0 }}</td>
            <td class="text-right text-warning">{{ line.still_to_be_delivered_qty|default_if_none:"0"|floatformat:0 }}</td>
            <td class="text-right text-success fw-semibold">{{ line.get_line_received_amount|default_if_none:"0"|floatformat:0 }}</td>
            <td class="text-right text-warning fw-semibold">{{ line.get_line_remaining_amount|default_if_none:"0"|floatformat:0 }}</td>
          </tr>
          {% endfor %}
          {% else %}
          <tr>
            <td colspan="18" class="text-center py-5">
              <div class="empty-state">
                <i class='bx bx-file-blank'></i>
                <h4>Aucune ligne trouvée</h4>
                <p>Ce bon de commande ne contient aucune ligne.</p>
              </div>
            </td>
          </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Résumé mobile -->
  <div class="d-none d-md-block mt-4">
    <div class="card bg-light border-0">
      <div class="card-body py-3">
        <div class="row text-center">
          <div class="col">
            <small class="text-muted">Total lignes</small>
            <div class="fw-bold text-primary">{{ lines|length }}</div>
          </div>
          <div class="col">
            <small class="text-muted">Dernière mise à jour</small>
            <div class="fw-bold">{{ purchase_order.updated_at|default:"—" }}</div>
          </div>
          <div class="col">
            <small class="text-muted">Statut</small>
            <div>
              {% if progress_rate == 100 %}
                <span class="badge bg-success">Complété</span>
              {% elif progress_rate > 0 %}
                <span class="badge bg-warning">En cours</span>
              {% else %}
                <span class="badge bg-secondary">Non commencé</span>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}